<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>iSSB - Character Select</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        body {
            background: linear-gradient(rgba(34, 16, 19, 0.9), rgba(34, 16, 19, 0.9));
            overflow: hidden;
            cursor: url('cursor.png') 32 32, auto;
        }
        
        .char-portrait {
            cursor: url('cursor.png') 32 32, pointer;
        }
        
        button {
            cursor: url('cursor.png') 32 32, pointer;
        }
        
        .container {
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .header {
            text-align: center;
            padding: 12px;
            font-size: 1.8rem;
            font-weight: bold;
            text-transform: uppercase;
            color: white;
            flex-shrink: 0;
        }
        
        .char-select-container {
            flex: 1;
            display: flex;
            gap: 12px;
            padding: 0 12px;
            height: 0;
            min-height: 0;
            overflow: hidden;
        }
        
        .player-panel {
            width: 220px;
            flex-shrink: 0;
        }
        
        .player-preview img {
            max-height: 250px;
        }
        
        .char-grid {
            max-height: none;
            overflow-y: auto;
        }
        
        .footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: rgba(0, 0, 0, 0.2);
            margin: 0 12px 12px 12px;
            flex-shrink: 0;
        }
        
        .ready-btn {
            font-size: 1.2rem;
            padding: 12px 24px;
            text-transform: uppercase;
        }
        
        /* Hand Cursor Sprite */
        .hand-cursor {
            position: absolute;
            width: 64px;
            height: 64px;
            background-image: url('cursor_sprites.png');
            /* Sprite sheet: 4 cursors in Base section, assuming 64x64 each = 256px wide total */
            background-size: 256px 64px;
            background-repeat: no-repeat;
            pointer-events: none;
            z-index: 1000;
            transition: transform 0.1s ease-out, background-position 0.1s ease-out;
            image-rendering: pixelated;
        }
        
        .hand-cursor.pointing {
            /* 3rd cursor - pointing hand (default) */
            background-position: -128px 0px;
        }
        
        .hand-cursor.grab {
            /* 1st cursor - grab hand (hovering) */
            background-position: 0px 0px;
        }
        
        .hand-cursor.open {
            /* 4th cursor - open hand (ready to select) */
            background-position: -192px 0px;
        }
        
        .hand-cursor.hidden {
            display: none;
        }
        
        /* Panel highlighting for joystick cursor */
        .player-panel.cursor-active {
            outline: 3px solid var(--color-primary);
            outline-offset: 4px;
            border-radius: 8px;
        }
        
        .player-panel.cursor-active.p1 {
            outline-color: var(--color-p1-blue);
        }
        
        .player-panel.cursor-active.p2 {
            outline-color: var(--color-p2-orange);
        }
        
        @media (max-height: 600px) {
            .header {
                font-size: 1.4rem;
                padding: 8px;
            }
            .player-panel {
                width: 180px;
            }
            .player-preview img {
                max-height: 180px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            Choose Your Fighter
        </header>
        
        <!-- Hand Cursor Indicator -->
        <div id="hand-cursor" class="hand-cursor pointing hidden"></div>
        
        <main class="char-select-container">
            <!-- Player 1 Panel -->
            <div class="player-panel p1" id="p1-panel">
                <div class="player-preview">
                    <img id="p1-image" src="" alt="Player 1 Character" style="display:none;">
                    <div id="p1-placeholder" style="color: rgba(255,255,255,0.3); font-size: 2.5rem;">?</div>
                    <h2 class="player-name" id="p1-name" style="font-size: 1.5rem;">Select</h2>
                    <p class="player-label" style="font-size: 0.9rem;">PLAYER 1</p>
                </div>
                <div style="text-align: center; margin-top: 8px;">
                    <button class="btn" id="p1-ready-btn" onclick="toggleReady(1)" style="width: 100%; background: var(--color-p1-blue); color: white; opacity: 0.5; cursor: not-allowed; padding: 10px; font-size: 0.95rem;" disabled>
                        Select Character
                    </button>
                    <p style="color: rgba(255,255,255,0.6); margin-top: 4px; font-size: 0.75rem;">Press 'E' to lock in</p>
                </div>
            </div>
            
            <!-- Character Grid -->
            <div style="flex: 1; display: flex; flex-direction: column;">
                <div class="char-grid" id="char-grid">
                    <!-- Characters will be dynamically loaded -->
                </div>
            </div>
            
            <!-- Player 2 Panel -->
            <div class="player-panel p2" id="p2-panel">
                <div class="player-preview">
                    <img id="p2-image" src="" alt="Player 2 Character" style="display:none;">
                    <div id="p2-placeholder" style="color: rgba(255,255,255,0.3); font-size: 2.5rem;">?</div>
                    <h2 class="player-name" id="p2-name" style="font-size: 1.5rem;">Select</h2>
                    <p class="player-label" style="font-size: 0.9rem;">PLAYER 2</p>
                </div>
                <div style="text-align: center; margin-top: 8px;">
                    <button class="btn" id="p2-ready-btn" onclick="toggleReady(2)" style="width: 100%; background: var(--color-p2-orange); color: white; opacity: 0.5; cursor: not-allowed; padding: 10px; font-size: 0.95rem;" disabled>
                        Select Character
                    </button>
                    <p style="color: rgba(255,255,255,0.6); margin-top: 4px; font-size: 0.75rem;">Press 'Enter' to lock in</p>
                </div>
            </div>
        </main>
        
        <footer class="footer">
            <button class="btn btn-secondary" onclick="goBack()">Back</button>
            <button class="btn btn-primary ready-btn" onclick="startFight()" id="fight-btn" disabled>FIGHT!</button>
        </footer>
    </div>
    
    <script>
        let p1Ready = false;
        let p2Ready = false;
        let p1Character = null;
        let p2Character = null;
        let currentPlayer = 1;
        let joystickActive = false;
        let cursorPanel = 1; // 1 or 2, indicates which panel cursor is on
        let gamepadConnected = false;
        
        // Hand cursor element
        const handCursor = document.getElementById('hand-cursor');
        const p1Panel = document.getElementById('p1-panel');
        const p2Panel = document.getElementById('p2-panel');
        
        // Load characters
        function loadCharacters() {
            const grid = document.getElementById('char-grid');
            
            // Try to get character list from Java bridge
            let characters = [];
            if (typeof MenuBridge !== 'undefined') {
                try {
                    const charJson = MenuBridge.getCharacterList();
                    characters = JSON.parse(charJson);
                } catch(e) {
                    console.error('Failed to load characters:', e);
                }
            }
            
            // Fallback placeholder characters
            if (characters.length === 0) {
                characters = [
                    {id: 0, name: 'Mario'},
                    {id: 1, name: 'Link'},
                    {id: 2, name: 'Pikachu'},
                    {id: 3, name: 'Kirby'},
                    {id: 4, name: 'Fox'},
                    {id: 5, name: 'Samus'},
                    {id: 6, name: 'Donkey Kong'},
                    {id: 7, name: 'Yoshi'}
                ];
            }
            
            characters.forEach(char => {
                const portrait = document.createElement('div');
                portrait.className = 'char-portrait';
                portrait.dataset.charId = char.id;
                portrait.dataset.charName = char.name;
                portrait.style.background = `linear-gradient(135deg, #${Math.floor(Math.random()*16777215).toString(16)}, #${Math.floor(Math.random()*16777215).toString(16)})`;
                portrait.innerHTML = `<div style="display:flex; align-items:center; justify-content:center; height:100%; font-weight:bold; text-align:center; font-size:0.8rem;">${char.name}</div>`;
                portrait.onclick = () => selectCharacter(char.id, char.name);
                portrait.onmouseenter = () => {
                    if (!joystickActive) {
                        handCursor.classList.remove('pointing', 'open');
                        handCursor.classList.add('grab');
                    }
                };
                portrait.onmouseleave = () => {
                    if (!joystickActive) {
                        handCursor.classList.remove('grab', 'open');
                        handCursor.classList.add('pointing');
                    }
                };
                portrait.tabIndex = 0;
                grid.appendChild(portrait);
            });
        }
        
        // Update hand cursor position and appearance
        function updateHandCursor() {
            if (!joystickActive || !gamepadConnected) {
                handCursor.classList.add('hidden');
                p1Panel.classList.remove('cursor-active');
                p2Panel.classList.remove('cursor-active');
                return;
            }
            
            handCursor.classList.remove('hidden');
            const targetPanel = cursorPanel === 1 ? p1Panel : p2Panel;
            const rect = targetPanel.getBoundingClientRect();
            
            // Position cursor at center-top of panel
            handCursor.style.left = (rect.left + rect.width / 2 - 32) + 'px';
            handCursor.style.top = (rect.top - 20) + 'px';
            
            // Update cursor state
            if (cursorPanel === 1 && p1Character) {
                handCursor.classList.remove('pointing', 'grab');
                handCursor.classList.add('open');
            } else if (cursorPanel === 2 && p2Character) {
                handCursor.classList.remove('pointing', 'grab');
                handCursor.classList.add('open');
            } else {
                handCursor.classList.remove('grab', 'open');
                handCursor.classList.add('pointing');
            }
            
            // Highlight active panel
            p1Panel.classList.toggle('cursor-active', cursorPanel === 1);
            p2Panel.classList.toggle('cursor-active', cursorPanel === 2);
        }
        
        // Gamepad/Joystick handling
        function checkGamepads() {
            const gamepads = navigator.getGamepads();
            let leftStickX = 0;
            let buttonA = false;
            let buttonB = false;
            
            for (let i = 0; i < gamepads.length; i++) {
                const gamepad = gamepads[i];
                if (gamepad && gamepad.connected) {
                    gamepadConnected = true;
                    // Left stick axes (index 0 = X, index 1 = Y)
                    if (gamepad.axes.length >= 2) {
                        leftStickX = gamepad.axes[0];
                    }
                    // Buttons (typically A=0, B=1 on most controllers)
                    if (gamepad.buttons.length >= 2) {
                        buttonA = gamepad.buttons[0]?.pressed || false;
                        buttonB = gamepad.buttons[1]?.pressed || false;
                    }
                    break; // Use first connected gamepad
                }
            }
            
            if (!gamepadConnected) {
                joystickActive = false;
                updateHandCursor();
                return;
            }
            
            // Handle joystick movement
            if (Math.abs(leftStickX) > 0.5) {
                joystickActive = true;
                const newPanel = leftStickX < -0.5 ? 1 : 2;
                if (newPanel !== cursorPanel) {
                    cursorPanel = newPanel;
                    currentPlayer = cursorPanel;
                    updateHandCursor();
                }
            }
            
            // Handle button presses
            if (buttonA && !window.lastButtonA) {
                // Select character for current panel
                if (cursorPanel === 1 && !p1Character) {
                    // Auto-select first character if none selected
                    const firstChar = document.querySelector('.char-portrait');
                    if (firstChar) {
                        const charId = parseInt(firstChar.dataset.charId);
                        const charName = firstChar.dataset.charName;
                        selectCharacter(charId, charName);
                    }
                } else if (cursorPanel === 1 && p1Character) {
                    toggleReady(1);
                } else if (cursorPanel === 2 && !p2Character) {
                    const firstChar = document.querySelector('.char-portrait');
                    if (firstChar) {
                        const charId = parseInt(firstChar.dataset.charId);
                        const charName = firstChar.dataset.charName;
                        selectCharacter(charId, charName);
                    }
                } else if (cursorPanel === 2 && p2Character) {
                    toggleReady(2);
                }
            }
            
            if (buttonB && !window.lastButtonB) {
                if (cursorPanel === 1 && p1Ready) {
                    toggleReady(1);
                } else if (cursorPanel === 2 && p2Ready) {
                    toggleReady(2);
                } else {
                    goBack();
                }
            }
            
            window.lastButtonA = buttonA;
            window.lastButtonB = buttonB;
            
            if (joystickActive) {
                updateHandCursor();
            }
        }
        
        // Poll gamepad state
        setInterval(checkGamepads, 50); // Check every 50ms
        
        // Listen for gamepad connect/disconnect
        window.addEventListener('gamepadconnected', (e) => {
            console.log('Gamepad connected:', e.gamepad.id);
            gamepadConnected = true;
            joystickActive = true;
            cursorPanel = 1;
            currentPlayer = 1;
            updateHandCursor();
        });
        
        window.addEventListener('gamepaddisconnected', (e) => {
            console.log('Gamepad disconnected:', e.gamepad.id);
            gamepadConnected = false;
            joystickActive = false;
            updateHandCursor();
        });
        
        function selectCharacter(charId, charName) {
            // Use cursorPanel if joystick is active, otherwise use currentPlayer
            const player = joystickActive ? cursorPanel : currentPlayer;
            
            // Update character selection
            if (player === 1) {
                p1Character = charId;
                document.getElementById('p1-name').textContent = charName;
                
                const btn = document.getElementById('p1-ready-btn');
                btn.disabled = false;
                btn.textContent = 'Ready!';
                btn.classList.add('btn-primary');
                btn.style.cursor = 'pointer';
                btn.style.opacity = '1';
                btn.style.background = 'var(--color-p1-blue)';
                btn.style.pointerEvents = 'auto';
                btn.onclick = function() { toggleReady(1); };
                
                // Remove previous selection
                document.querySelectorAll('.selected-p1').forEach(el => el.classList.remove('selected-p1'));
                // Mark new selection
                document.querySelector(`[data-char-id="${charId}"]`).classList.add('selected-p1');
            } else {
                p2Character = charId;
                document.getElementById('p2-name').textContent = charName;
                
                const btn = document.getElementById('p2-ready-btn');
                btn.disabled = false;
                btn.textContent = 'Ready!';
                btn.style.background = 'var(--color-p2-orange)';
                btn.style.color = 'white';
                btn.style.cursor = 'pointer';
                btn.style.opacity = '1';
                
                // Remove previous selection
                document.querySelectorAll('.selected-p2').forEach(el => el.classList.remove('selected-p2'));
                // Mark new selection
                document.querySelector(`[data-char-id="${charId}"]`).classList.add('selected-p2');
            }
            
            // Notify Java layer
            if (typeof MenuBridge !== 'undefined') {
                MenuBridge.selectCharacter(player, charId);
            }
            
            // Auto-switch to next player (only if not using joystick)
            if (!joystickActive) {
                currentPlayer = currentPlayer === 1 ? 2 : 1;
            } else {
                // Update cursor position after selection
                updateHandCursor();
            }
            
            checkReadyState();
        }
        
        function toggleReady(player) {
            if (player === 1) {
                if (!p1Character) {
                    alert('Please select a character first!');
                    return;
                }
                p1Ready = !p1Ready;
                const btn = document.getElementById('p1-ready-btn');
                if (p1Ready) {
                    btn.textContent = 'Cancel';
                    btn.style.background = '#666';
                } else {
                    btn.textContent = 'Ready!';
                    btn.style.background = 'var(--color-p1-blue)';
                }
            } else {
                if (!p2Character) {
                    alert('Please select a character first!');
                    return;
                }
                p2Ready = !p2Ready;
                const btn = document.getElementById('p2-ready-btn');
                if (p2Ready) {
                    btn.textContent = 'Cancel';
                    btn.style.background = '#666';
                } else {
                    btn.textContent = 'Ready!';
                    btn.style.background = 'var(--color-primary)';
                }
            }
            checkReadyState();
        }
        
        function checkReadyState() {
            const fightBtn = document.getElementById('fight-btn');
            if (p1Ready && p2Ready) {
                fightBtn.disabled = false;
                fightBtn.style.animation = 'pulse 1s infinite';
            } else {
                fightBtn.disabled = true;
                fightBtn.style.animation = '';
            }
        }
        
        function startFight() {
            if (p1Ready && p2Ready) {
                // Go to stage select instead of directly starting the game
                if (typeof MenuBridge !== 'undefined') {
                    MenuBridge.navigateTo('stage_select');
                } else {
                    window.location.href = 'stage_select.html';
                }
            }
        }
        
        function goBack() {
            if (typeof MenuBridge !== 'undefined') {
                MenuBridge.navigateTo('main_menu');
            } else {
                window.location.href = 'main_menu.html';
            }
        }
        
        // Keyboard controls
        document.addEventListener('keydown', (e) => {
            if (e.key === 'e' || e.key === 'E') {
                toggleReady(1);
            } else if (e.key === 'Enter') {
                if (p1Ready && p2Ready) {
                    startFight();
                } else {
                    toggleReady(2);
                }
            }
        });
        
        // Initialize
        loadCharacters();
        
        // Initialize cursor position
        updateHandCursor();
    </script>
    
    <!-- Menu Music -->
    <audio id="menuMusic" loop>
        <source src="menu_music.mp3" type="audio/mpeg">
    </audio>
    <script>
        // Persistent menu music across all menu pages
        const menuMusic = document.getElementById('menuMusic');
        if (menuMusic) {
            // Get saved music state from localStorage
            const savedMusicState = localStorage.getItem('menuMusicState');
            let musicWasPlaying = false;
            let savedCurrentTime = 0;
            let savedVolume = 0.7;
            
            if (savedMusicState) {
                try {
                    const state = JSON.parse(savedMusicState);
                    musicWasPlaying = state.playing === true;
                    savedCurrentTime = state.currentTime || 0;
                    savedVolume = state.volume || 0.7;
                } catch (e) {
                    console.log('Failed to parse saved music state:', e);
                }
            }
            
            // Set volume from saved state
            menuMusic.volume = savedVolume;
            
            // If music was playing, restore position and continue
            if (musicWasPlaying && savedCurrentTime > 0) {
                menuMusic.currentTime = savedCurrentTime;
            }
            
            // Save music state periodically
            function saveMusicState() {
                const state = {
                    playing: !menuMusic.paused,
                    currentTime: menuMusic.currentTime,
                    volume: menuMusic.volume
                };
                localStorage.setItem('menuMusicState', JSON.stringify(state));
            }
            
            // Save state every second
            setInterval(saveMusicState, 1000);
            
            // Save state when music ends/pauses
            menuMusic.addEventListener('pause', saveMusicState);
            menuMusic.addEventListener('ended', saveMusicState);
            menuMusic.addEventListener('timeupdate', () => {
                if (!menuMusic.paused) {
                    saveMusicState();
                }
            });
            
            // Try to play music on page load
            function playMenuMusic() {
                if (!musicWasPlaying) {
                    menuMusic.play().catch(e => {
                        console.log('Autoplay blocked, will play on user interaction');
                    });
                } else {
                    menuMusic.play().catch(e => {
                        console.log('Resume blocked, will play on user interaction');
                    });
                }
            }
            
            document.addEventListener('click', () => {
                if (menuMusic.paused) {
                    menuMusic.play().catch(e => console.log('Music play failed:', e));
                }
            }, { once: true });
            
            playMenuMusic();
        }
    </script>
</body>
</html>

